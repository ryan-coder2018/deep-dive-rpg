<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deep Dive RPG - Flat Aesthetic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; margin: 0; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; color: #f8fafc; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .interactive { pointer-events: auto; }

        .menu-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(2, 6, 23, 0.98); z-index: 50; 
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; pointer-events: auto;
        }

        .scroll-area {
            width: 100%; max-width: 450px; max-height: 70vh; overflow-y: auto; 
            padding: 12px; border: 1px solid #1e293b; background: #0f172a; border-radius: 12px;
        }

        .species-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }

        .fish-card {
            background: #1e293b; border: 1px solid #334155;
            border-radius: 6px; padding: 4px; text-align: center; position: relative;
        }
        .fish-card.found { border-color: var(--rarity-color); background: rgba(255, 255, 255, 0.05); }
        
        .detail-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 320px; background: #0f172a; border: 2px solid #334155;
            border-radius: 24px; padding: 24px; z-index: 100; display: none;
            text-align: center; pointer-events: auto;
        }

        .btn {
            background: #1e293b; color: white; border: 1px solid #334155;
            border-radius: 12px; font-weight: bold; user-select: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn:active { background: #334155; transform: scale(0.95); }

        .d-pad {
            position: absolute; bottom: 30px; left: 20px;
            display: grid; grid-template-columns: repeat(3, 54px); grid-template-rows: repeat(3, 54px);
            gap: 8px; pointer-events: none;
        }

        .action-pad {
            position: absolute; bottom: 30px; right: 20px;
            display: flex; flex-direction: column; gap: 12px;
            width: 100px; pointer-events: none;
        }

        .biome-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; margin-bottom: 8px; border-radius: 12px; background: #1e293b;
            border: 1px solid #334155;
        }
        .biome-item.unlocked { cursor: pointer; border-left-width: 6px; }
        .biome-item.locked { opacity: 0.3; filter: grayscale(1); }

        .catch-anim {
            position: absolute; pointer-events: none; animation: floatUp 0.8s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
            font-weight: 900; z-index: 1000;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            30% { transform: translateY(-30px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-100px) scale(1); opacity: 0; }
        }

        .xp-bar-container {
            width: 100%; height: 6px; background: #1e293b; border-radius: 3px; margin-top: 6px; overflow: hidden;
        }
        #xp-bar-fill {
            height: 100%; background: #22d3ee; width: 0%; transition: width 0.3s;
        }
    </style>
</head>
<body>

<canvas id="game"></canvas>

<div id="ui-layer">
    <div class="flex justify-between p-4 interactive">
        <div class="bg-slate-950/90 p-3 rounded-xl border border-slate-700 backdrop-blur-md min-w-[140px]">
            <div id="ui-biome" class="text-cyan-400 text-[10px] font-black uppercase tracking-[0.15em]">---</div>
            <div class="flex justify-between items-end mt-1">
                <div id="ui-lvl" class="text-white text-xs font-black">RANK: 1</div>
                <div id="ui-xp-text" class="text-slate-400 text-[9px] font-mono">0/100</div>
            </div>
            <div class="xp-bar-container">
                <div id="xp-bar-fill"></div>
            </div>
        </div>
        <div class="bg-slate-950/90 p-3 rounded-xl border border-slate-700 text-center min-w-[100px] backdrop-blur-md">
            <div id="ui-coins" class="text-yellow-400 font-black text-lg leading-none">$0</div>
            <div class="text-slate-500 text-[8px] uppercase tracking-widest mt-1">Credits</div>
        </div>
        <div class="bg-slate-950/90 p-3 rounded-xl border border-slate-700 text-right backdrop-blur-md">
            <div id="ui-log-count" class="text-white text-xs font-black">0 / 1000</div>
            <div class="text-slate-500 text-[8px] uppercase tracking-widest mt-1">Registry</div>
        </div>
    </div>

    <div class="d-pad">
        <div id="ctrl-nw" class="btn text-xs opacity-40 interactive">â†–</div>
        <div id="ctrl-up" class="btn interactive text-xl">â–²</div>
        <div id="ctrl-ne" class="btn text-xs opacity-40 interactive">â†—</div>
        <div id="ctrl-left" class="btn interactive text-xl">â—€</div>
        <div class="rounded-full"></div>
        <div id="ctrl-right" class="btn interactive text-xl">â–¶</div>
        <div id="ctrl-sw" class="btn text-xs opacity-40 interactive">â†™</div>
        <div id="ctrl-down" class="btn interactive text-xl">â–¼</div>
        <div id="ctrl-se" class="btn text-xs opacity-40 interactive">â†˜</div>
    </div>

    <div class="action-pad">
        <div id="btn-map" class="btn interactive h-16 border-emerald-500/50 text-emerald-400 shadow-lg">MAP</div>
        <div id="btn-log" class="btn interactive h-16 border-cyan-500/50 text-cyan-400 shadow-lg">LOG</div>
    </div>
</div>

<div id="map-menu" class="menu-overlay">
    <div class="text-center mb-6">
        <h2 class="text-emerald-400 font-black uppercase tracking-[0.3em] text-2xl">Navigation</h2>
        <p class="text-slate-500 text-xs">Progress: 10, 20, 30+ ranks per biome.</p>
    </div>
    <div id="map-list" class="scroll-area"></div>
    <button class="mt-6 text-slate-400 font-bold px-12 py-3 border border-slate-800 rounded-2xl" onclick="closeMenus()">DISMISS</button>
</div>

<div id="log-menu" class="menu-overlay">
    <div class="text-center mb-6">
        <h2 class="text-cyan-400 font-black uppercase tracking-[0.3em] text-2xl">The Registry</h2>
        <p class="text-slate-500 text-xs">Discovery Progress of 1,000 species.</p>
    </div>
    <div class="scroll-area">
        <div class="species-grid" id="log-grid"></div>
    </div>
    <button class="mt-6 btn border-cyan-500 text-cyan-400 px-16 h-14 text-lg" onclick="closeMenus()">RETURN</button>
</div>

<div id="detail-modal" class="detail-modal">
    <div id="det-rarity" class="inline-block px-3 py-1 rounded-full text-[10px] font-black uppercase mb-4">RARITY</div>
    <div id="det-id" class="text-[10px] text-slate-500 font-mono">#0000</div>
    <h3 id="det-name" class="text-2xl font-black my-2">???</h3>
    <div id="det-box" class="w-32 h-20 mx-auto rounded-2xl my-6 border-4 border-white/5 relative flex items-center justify-center">
        <div id="det-fish-vis" class="w-16 h-10 rounded-full"></div>
    </div>
    <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-slate-900/50 p-3 rounded-xl border border-slate-800">
            <div class="text-slate-500 text-[9px] uppercase font-bold">Encounters</div>
            <div id="det-count" class="font-black text-xl">0</div>
        </div>
        <div class="bg-slate-900/50 p-3 rounded-xl border border-slate-800">
            <div class="text-slate-500 text-[9px] uppercase font-bold">Credits</div>
            <div id="det-pb" class="font-black text-xl">0</div>
        </div>
    </div>
    <button class="bg-slate-800 text-white w-full py-4 rounded-2xl font-black text-lg" onclick="document.getElementById('detail-modal').style.display='none'">CLOSE</button>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const GLOBAL_FISH_SPEED = 4.0;
    const GLOBAL_FISH_RADIUS = 12;
    const GLOBAL_XP_VALUE = 5; 

    const RARITIES = {
        SUPER_COMMON: { name: 'Super Common', color: '#94a3b8', multiplier: 1 },
        COMMON: { name: 'Common', color: '#4ade80', multiplier: 2 },
        UNCOMMON: { name: 'Uncommon', color: '#60a5fa', multiplier: 5 },
        RARE: { name: 'Rare', color: '#c084fc', multiplier: 12 },
        LEGENDARY: { name: 'Legendary', color: '#fbbf24', multiplier: 30 },
        MYTHICAL: { name: 'Mythical', color: '#f472b6', multiplier: 100 },
        ASTROL: { name: 'Astrol', color: '#22d3ee', multiplier: 500 }
    };

    const BIOMES = [
        { id: 0, name: 'Sunlit Shallows', bg: '#0ea5e9', particle: '#bae6fd' },
        { id: 1, name: 'Coral Gardens', bg: '#0284c7', particle: '#f472b6' },
        { id: 2, name: 'Kelp Forest', bg: '#065f46', particle: '#34d399' },
        { id: 3, name: 'Shipwreck Cove', bg: '#292524', particle: '#a8a29e' },
        { id: 4, name: 'Twilight Zone', bg: '#1e1b4b', particle: '#818cf8' },
        { id: 5, name: 'Midnight Trench', bg: '#000000', particle: '#312e81' },
        { id: 6, name: 'Glass Reef', bg: '#0f172a', particle: '#f0f9ff' },
        { id: 7, name: 'Crystal Caves', bg: '#312e81', particle: '#e879f9' },
        { id: 8, name: 'Void Singularity', bg: '#000000', particle: '#ffffff' }
    ];

    // Calculate dynamic requirements (10, 20, 30 leaps)
    BIOMES.forEach((b, i) => {
        if (i === 0) {
            b.minRank = 1;
        } else {
            let total = 1;
            for (let k = 1; k <= i; k++) { total += (k * 10); }
            b.minRank = total;
        }
    });

    const SPECIES_COLORS = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef', '#f43f5e', '#ec4899', '#78716c', '#475569', '#0891b2', '#ea580c', '#65a30d', '#16a34a', '#2563eb', '#9333ea'];

    const FISH_DATA = [];
    const rKeys = Object.keys(RARITIES);
    const prefixes = ["Neon", "Silver", "Golden", "Ghost", "Dark", "Spotted", "Striped", "Giant", "Mini", "Electric", "Abyssal", "Crystalline", "Volcanic", "Arctic", "Ancient", "Cyber", "Void", "Spectral", "Prismatic", "Majestic"];
    const bodies = ["Tetra", "Guppy", "Molly", "Angelfish", "Catfish", "Shark", "Ray", "Tuna", "Cod", "Eel", "Bass", "Snapper", "Mackerel", "Swordfish", "Salmon", "Trout", "Carp", "Goby", "Blenny", "Puffer"];

    for(let i=0; i<1000; i++) {
        const rarityKey = rKeys[Math.floor(Math.random() * rKeys.length)];
        const speciesColor = SPECIES_COLORS[Math.floor(Math.random() * SPECIES_COLORS.length)];
        const numBiomes = Math.floor(Math.random() * 4) + 1;
        const startBiome = Math.floor(Math.random() * (BIOMES.length - numBiomes + 1));
        const habitatIndices = [];
        for(let j=0; j<numBiomes; j++) habitatIndices.push(startBiome + j);

        FISH_DATA.push({
            id: i + 1,
            name: `${prefixes[i % prefixes.length]} ${bodies[(i * 3) % bodies.length]}`,
            rarity: rarityKey,
            color: speciesColor,
            habitats: habitatIndices
        });
    }

    const state = {
        running: true,
        lvl: 1,
        xp: 0,
        coins: 0,
        stats: {}, 
        biome: BIOMES[0],
        player: { x: 100, y: 0, r: 18, speed: 7.2 },
        fish: [],
        input: {}
    };

    function syncUI() {
        document.getElementById('ui-biome').innerText = state.biome.name;
        document.getElementById('ui-lvl').innerText = "RANK: " + state.lvl;
        document.getElementById('ui-xp-text').innerText = `${state.xp}/100`;
        document.getElementById('xp-bar-fill').style.width = `${state.xp}%`;
        document.getElementById('ui-coins').innerText = "$" + Math.floor(state.coins).toLocaleString();
        document.getElementById('ui-log-count').innerText = Object.keys(state.stats).length + " / 1000";
    }

    function spawnCatchText(x, y, text, color) {
        const el = document.createElement('div');
        el.className = 'catch-anim';
        el.style.left = x + 'px'; el.style.top = y + 'px';
        el.style.color = color; el.innerText = text;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 800);
    }

    function update() {
        if(!state.running) return;

        let moveX = 0, moveY = 0;
        if(state.input['up'] || state.input['nw'] || state.input['ne']) moveY -= 1;
        if(state.input['down'] || state.input['sw'] || state.input['se']) moveY += 1;
        if(state.input['left'] || state.input['nw'] || state.input['sw']) moveX -= 1;
        if(state.input['right'] || state.input['ne'] || state.input['se']) moveX += 1;

        if (moveX !== 0 || moveY !== 0) {
            const length = Math.hypot(moveX, moveY);
            state.player.x += (moveX / length) * state.player.speed;
            state.player.y += (moveY / length) * state.player.speed;
        }

        state.player.x = Math.max(30, Math.min(canvas.width - 30, state.player.x));
        state.player.y = Math.max(30, Math.min(canvas.height - 30, state.player.y));

        if(Math.random() < 0.12) {
            const availableFish = FISH_DATA.filter(f => f.habitats.includes(state.biome.id));
            if(availableFish.length > 0) {
                const pickCandidate = availableFish[Math.floor(Math.random() * availableFish.length)];
                const rarityChance = 1 / (rKeys.indexOf(pickCandidate.rarity) + 1);
                
                if (Math.random() < rarityChance) {
                    state.fish.push({
                        x: canvas.width + 150,
                        y: 50 + Math.random() * (canvas.height - 100),
                        r: GLOBAL_FISH_RADIUS,
                        data: pickCandidate,
                        weight: (rKeys.indexOf(pickCandidate.rarity) + 1) * 10,
                        osc: Math.random() * 100,
                        speed: GLOBAL_FISH_SPEED
                    });
                }
            }
        }

        for(let i = state.fish.length-1; i >= 0; i--) {
            const f = state.fish[i];
            f.x -= f.speed;
            f.y += Math.sin(f.x / 60 + f.osc) * 1.5;
            
            const d = Math.hypot(state.player.x - f.x, state.player.y - f.y);
            if(d < state.player.r + f.r) {
                const sid = f.data.id;
                const rInfo = RARITIES[f.data.rarity];
                if(!state.stats[sid]) state.stats[sid] = { count: 0, coins: 0 };
                state.stats[sid].count++;
                state.xp += GLOBAL_XP_VALUE;
                if (state.xp >= 100) {
                    state.lvl += 1;
                    state.xp = Math.max(0, state.xp - 100);
                }
                const reward = f.weight * rInfo.multiplier;
                state.coins += reward;
                state.stats[sid].coins += reward;
                spawnCatchText(f.x, f.y, `+${GLOBAL_XP_VALUE} XP`, rInfo.color);
                state.fish.splice(i, 1);
                syncUI();
            } else if(f.x < -200) state.fish.splice(i, 1);
        }
    }

    function draw() {
        ctx.fillStyle = state.biome.bg;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Environment particles (kept subtle, not "glow")
        ctx.fillStyle = state.biome.particle;
        ctx.globalAlpha = 0.1;
        for(let i=0; i<15; i++) {
            const time = Date.now() / 2000;
            const px = (Math.sin(i + time) * 100 + i * canvas.width/8) % canvas.width;
            const py = (Math.cos(i + time) * 50 + i * canvas.height/8) % canvas.height;
            ctx.beginPath(); ctx.arc(px, py, 1.5, 0, Math.PI*2); ctx.fill();
        }
        ctx.globalAlpha = 1;

        // Submarine
        ctx.save();
        ctx.translate(state.player.x, state.player.y);
        ctx.fillStyle = "#facc15";
        ctx.beginPath();
        ctx.roundRect(-state.player.r*1.5, -state.player.r, state.player.r*3, state.player.r*2, state.player.r);
        ctx.fill();
        ctx.fillStyle = "#0f172a";
        ctx.beginPath(); ctx.arc(state.player.r * 0.8, 0, 6, 0, Math.PI*2); ctx.fill();
        ctx.restore();

        // Fish (Strictly NO glow)
        state.fish.forEach(f => {
            ctx.save();
            ctx.translate(f.x, f.y);
            
            // Explicitly clearing any shadow context
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
            
            ctx.fillStyle = f.data.color;
            ctx.beginPath();
            ctx.ellipse(0, 0, f.r * 1.4, f.r, 0, 0, Math.PI*2);
            ctx.fill();
            
            // Tail
            ctx.beginPath();
            ctx.moveTo(f.r * 0.8, 0);
            ctx.lineTo(f.r * 1.8, -f.r * 0.8);
            ctx.lineTo(f.r * 1.8, f.r * 0.8);
            ctx.fill();
            
            // Eye
            ctx.fillStyle = "rgba(0,0,0,0.6)";
            ctx.beginPath(); ctx.arc(-f.r * 0.7, -f.r * 0.2, 1.8, 0, Math.PI*2); ctx.fill();
            ctx.restore();
        });
    }

    function closeMenus() {
        document.getElementById('map-menu').style.display = 'none';
        document.getElementById('log-menu').style.display = 'none';
        state.running = true;
    }

    document.getElementById('btn-map').onclick = () => {
        state.running = false;
        const list = document.getElementById('map-list');
        list.innerHTML = '';
        BIOMES.forEach(b => {
            const locked = state.lvl < b.minRank;
            const item = document.createElement('div');
            item.className = `biome-item ${locked ? 'locked' : 'unlocked'}`;
            if(!locked) item.style.borderLeftColor = b.particle;
            
            let statusText = locked ? `RANK ${b.minRank} REQUIRED` : (state.biome.id === b.id ? 'CURRENT' : 'STATIONED');
            item.innerHTML = `
                <div class="flex-1">
                    <div class="text-sm font-black text-white uppercase">${b.name}</div>
                    <div class="text-[9px] font-bold text-slate-400 mt-1">${statusText}</div>
                </div>
                <div class="text-xs">${locked ? 'ðŸ”’' : 'âž¤'}</div>
            `;
            if(!locked) {
                item.onclick = () => {
                    state.biome = b;
                    state.fish = [];
                    closeMenus();
                    syncUI();
                };
            }
            list.appendChild(item);
        });
        document.getElementById('map-menu').style.display = 'flex';
    };

    document.getElementById('btn-log').onclick = () => {
        state.running = false;
        const grid = document.getElementById('log-grid');
        grid.innerHTML = '';
        FISH_DATA.forEach(f => {
            const s = state.stats[f.id];
            const rInfo = RARITIES[f.rarity];
            const card = document.createElement('div');
            card.className = `fish-card ${s ? 'found' : ''}`;
            card.style.setProperty('--rarity-color', rInfo.color);
            card.innerHTML = `
                <div class="w-full h-1 rounded-full mb-1" style="background:${s ? f.color : '#1e293b'}"></div>
                <div class="text-[7px] font-bold text-slate-500 font-mono">${String(f.id).padStart(3,'0')}</div>
            `;
            card.onclick = () => {
                const modal = document.getElementById('detail-modal');
                const rEl = document.getElementById('det-rarity');
                rEl.innerText = rInfo.name;
                rEl.style.backgroundColor = rInfo.color;
                rEl.style.color = (f.rarity === 'SUPER_COMMON' || f.rarity === 'ASTROL') ? '#000' : '#fff';
                document.getElementById('det-id').innerText = "#" + String(f.id).padStart(4, '0');
                document.getElementById('det-name').innerText = s ? f.name : "???";
                document.getElementById('det-fish-vis').style.backgroundColor = s ? f.color : "#1e293b";
                document.getElementById('det-count').innerText = s ? s.count : "0";
                document.getElementById('det-pb').innerText = s ? s.coins.toLocaleString() : "0";
                modal.style.display = 'block';
            };
            grid.appendChild(card);
        });
        document.getElementById('log-menu').style.display = 'flex';
    };

    function setupKeys() {
        const controls = ['ctrl-up','ctrl-down','ctrl-left','ctrl-right','ctrl-nw','ctrl-ne','ctrl-sw','ctrl-se'];
        controls.forEach(id => {
            const key = id.split('-')[1];
            const el = document.getElementById(id);
            const start = (e) => { e.preventDefault(); state.input[key] = true; };
            const end = (e) => { e.preventDefault(); state.input[key] = false; };
            el.addEventListener('mousedown', start);
            el.addEventListener('touchstart', start, {passive: false});
            el.addEventListener('mouseup', end);
            el.addEventListener('touchend', end, {passive: false});
            el.addEventListener('mouseleave', end);
        });
    }

    window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    window.onload = () => {
        window.onresize();
        state.player.y = canvas.height / 2;
        setupKeys();
        syncUI();
        (function loop() { update(); draw(); requestAnimationFrame(loop); })();
    };
</script>
</body>
</html>
